!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("nostr-tools"),require("@getalby/lightning-tools")):"function"==typeof define&&define.amd?define(["exports","nostr-tools","@getalby/lightning-tools"],t):t((e||self).sdk={},e.nostrTools,e.lightningTools)}(this,function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function i(){return i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},i.apply(this,arguments)}function s(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,c(e,t)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}function c(e,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},c(e,t)}function a(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function l(e,t,n){return l=a()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&c(o,n.prototype),o},l.apply(null,arguments)}function h(e){var t="function"==typeof Map?new Map:void 0;return h=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return l(e,arguments,u(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),c(n,e)},h(e)}function f(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)t.indexOf(n=i[r])>=0||(o[n]=e[n]);return o}var d=/*#__PURE__*/function(){function e(){this.events={}}var t=e.prototype;return t.on=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},t.off=function(e,t){this.events[e]&&(this.events[e]=this.events[e].filter(function(e){return e!==t}))},t.emit=function(e,t){this.events[e]&&this.events[e].forEach(function(e){return e(t)})},e}();function v(e){return Object.entries(e).map(function(e){var t=e[0],n=e[1];return t&&n?t+"="+n:""}).filter(function(e){return e}).join("&")}function p(e,t){return"Basic "+btoa(e+":"+t)}var m={__proto__:null,buildQueryString:v,basicAuthHeader:p},y=/*#__PURE__*/function(e){function t(t,n,r,o){var i,s=t.toString();return n&&(s+=" "+n),s+=": ",s+=o.message?o.message:JSON.stringify(o),(i=e.call(this,s)||this).status=void 0,i.statusText=void 0,i.headers=void 0,i.error=void 0,i.status=t,i.statusText=n,i.headers=r,i.error=o,i}return s(t,e),t}(/*#__PURE__*/h(Error)),P={__proto__:null,OAuthClient:function(){},AuthClient:function(){},AlbyResponseError:y},g=["auth","endpoint","params","request_body","method","max_retries","base_url","user_agent","headers"],w=function(e){return Promise.resolve(b(e)).then(function(e){return e.json()})},b=function(e){var t=e.auth,n=e.endpoint,r=e.params,o=void 0===r?{}:r,s=e.request_body,u=e.method,c=e.max_retries,a=e.base_url,l=void 0===a?k:a,h=e.user_agent,d=e.headers,p=f(e,g);try{var m=function(e){return Promise.resolve(_(P.toString(),i({headers:i({},w?{"Content-Type":"application/json; charset=utf-8"}:void 0,e,d,{"User-Agent":null!=h?h:"@getalby/sdk","X-User-Agent":null!=h?h:"@getalby/sdk"}),method:u,body:w?JSON.stringify(s):void 0},p),c)).then(function(e){var t=function(){if(!e.ok)return Promise.resolve(e.json()).then(function(t){throw new y(e.status,e.statusText,e.headers,t)})}();return t&&t.then?t.then(function(t){return e}):e})},P=new URL(l+n);P.search=v(o);var w="POST"===u&&!!s;return Promise.resolve(t?Promise.resolve(t.getAuthHeader(P.href,u)).then(m):m(void 0))}catch(e){return Promise.reject(e)}},_=function e(t,n,r){void 0===r&&(r=0);try{return Promise.resolve(fetch(t,n)).then(function(o){var i,s=function(){if(429===o.status&&r>0){var s=Number(o.headers.get("x-rate-limit-reset")),u=Number(o.headers.get("x-rate-limit-remaining")),c=1e3*s-Date.now(),a=1e3;return 0===u&&(a=c),Promise.resolve(new Promise(function(e){return setTimeout(e,a)})).then(function(){var o=e(t,n,r-1);return i=1,o})}}();return s&&s.then?s.then(function(e){return i?e:o}):i?s:o})}catch(e){return Promise.reject(e)}},k="https://api.getalby.com",E=function(e){return e.reduce(function(e,t){return e+t.toString(16).padStart(2,"0")},"")},T=["expires_in"],N=["token"];function j(e){var t=e.expires_in;return i({},f(e,T),!!t&&{expires_at:Date.now()+1e3*t})}var R=/*#__PURE__*/function(){function e(e){this.token=void 0,this.options=void 0,this.code_verifier=void 0,this.code_challenge=void 0,this._refreshAccessTokenPromise=void 0,this._tokenEvents=void 0,this._tokenEvents=new d;var t=e.token,n=f(e,N);this.options=i({client_secret:""},n),this.token=t,this._refreshAccessTokenPromise=null}var t=e.prototype;return t.on=function(e,t){this._tokenEvents.on(e,t)},t.refreshAccessToken=function(){try{var e=this;return e._refreshAccessTokenPromise||(e._refreshAccessTokenPromise=new Promise(function(t,n){try{return Promise.resolve(function(r,o){try{var s=function(n,r){try{var o=function(){var n,r=null==(n=e.token)?void 0:n.refresh_token,o=e.options,s=o.client_id,u=o.client_secret,c=o.request_options,a=o.user_agent;if(!s)throw new Error("client_id is required");if(!r)throw new Error("refresh_token is required");return Promise.resolve(w(i({},c,{endpoint:"/oauth/token",params:{client_id:s,grant_type:"refresh_token",refresh_token:r},user_agent:a,method:"POST",headers:i({},null==c?void 0:c.headers,{"Content-type":"application/x-www-form-urlencoded"},{Authorization:p(s,u)})}))).then(function(n){var r=j(n);e.token=r,t({token:r}),e._tokenEvents.emit("tokenRefreshed",e.token)})}()}catch(e){return r(e)}return o&&o.then?o.then(void 0,r):o}(0,function(t){console.error(t),n(t),e._tokenEvents.emit("tokenRefreshFailed",t)})}catch(e){return o(!0,e)}return s&&s.then?s.then(o.bind(null,!1),o.bind(null,!0)):o(!1,s)}(0,function(t,n){if(e._refreshAccessTokenPromise=null,t)throw n;return n}))}catch(e){return Promise.reject(e)}})),Promise.resolve(e._refreshAccessTokenPromise)}catch(e){return Promise.reject(e)}},t.isAccessTokenExpired=function(){var e,t,n=null==(e=this.token)?void 0:e.refresh_token,r=null==(t=this.token)?void 0:t.expires_at;return!r||!!n&&r<=Date.now()+1e3},t.requestAccessToken=function(e){try{var t=this,n=t.options,r=n.client_id,o=n.client_secret,s=n.callback,u=n.request_options,c=n.user_agent,a=t.code_verifier;if(!r)throw new Error("client_id is required");if(!o&&!a)throw new Error("either client_secret is required, or code should be generated using a challenge");if(!s)throw new Error("callback is required");return Promise.resolve(w(i({},u,{endpoint:"/oauth/token",params:{code:e,grant_type:"authorization_code",code_verifier:a,client_id:r,redirect_uri:s},user_agent:c,method:"POST",headers:i({},null==u?void 0:u.headers,{"Content-Type":"application/x-www-form-urlencoded"},{Authorization:p(r,o)})}))).then(function(e){var n=j(e);return t.token=n,{token:n}})}catch(e){return Promise.reject(e)}},t.generateAuthURL=function(e){try{var t=function(){var t=n.code_challenge,o=new URL(e.authorizeUrl||"https://getalby.com/oauth");return o.search=v(i({},e,{client_id:s,scope:c.join(" "),response_type:"code",redirect_uri:u,code_challenge_method:r,code_challenge:t})),o.toString()},n=this;e||(e={});var r,o=n.options,s=o.client_id,u=o.callback,c=o.scopes;if(!u)throw new Error("callback required");if(!c)throw new Error("scopes required");var a=function(){if("S256"===e.code_challenge_method)return Promise.resolve(n._generateS256Challenge()).then(function(){r="S256"});"plain"===e.code_challenge_method&&e.code_challenge&&(n.code_challenge=e.code_challenge,n.code_verifier=e.code_challenge,r="plain")}();return Promise.resolve(a&&a.then?a.then(t):t())}catch(e){return Promise.reject(e)}},t.getAuthHeader=function(){try{var e,t=function(){return{Authorization:"Bearer "+n.token.access_token}},n=this;if(null==(e=n.token)||!e.access_token)throw new Error("access_token is required");var r=function(){if(n.isAccessTokenExpired())return Promise.resolve(n.refreshAccessToken()).then(function(){})}();return Promise.resolve(r&&r.then?r.then(t):t())}catch(e){return Promise.reject(e)}},t._generateS256Challenge=function(){try{var e=this,t=crypto.getRandomValues(new Uint8Array(64));return e.code_verifier=E(t),Promise.resolve(crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e.code_verifier))).then(function(t){var n=new Uint8Array(t);e.code_challenge=btoa(String.fromCharCode.apply(String,n)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")})}catch(e){return Promise.reject(e)}},e}(),q=/*#__PURE__*/function(){function e(e){this.bearer_token=void 0,this.bearer_token=e}return e.prototype.getAuthHeader=function(){return{Authorization:"Bearer "+this.bearer_token}},e}(),S={__proto__:null,OAuth2User:R,OAuth2Bearer:q};function I(e){var t={};return e.recipient.customKey&&e.recipient.customValue&&(t[e.recipient.customKey]=e.recipient.customValue),t[7629169]=JSON.stringify(e.boostagram),{destination:e.recipient.address,amount:e.amount,custom_records:t}}var O=/*#__PURE__*/function(){function e(e,t){this.auth=void 0,this.defaultRequestOptions=void 0,this.auth="string"==typeof e?new q(e):e,this.defaultRequestOptions=i({},t,{user_agent:null==t?void 0:t.user_agent})}var t=e.prototype;return t.accountBalance=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/balance",params:e,method:"GET"}))},t.signMessage=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/signatures",request_body:e,method:"POST"}))},t.accountSummary=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/summary",params:e,method:"GET"}))},t.accountInformation=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/me",params:e,method:"GET"}))},t.accountValue4Value=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/user/value4value",params:e,method:"GET"}))},t.incomingInvoices=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/incoming",params:e,method:"GET"}))},t.outgoingInvoices=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/outgoing",params:e,method:"GET"}))},t.invoices=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices",params:e,method:"GET"}))},t.getInvoice=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices/"+e,method:"GET"}))},t.decodeInvoice=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/decode/bolt11/"+e,method:"GET"}))},t.createInvoice=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/invoices",request_body:e,method:"POST"}))},t.keysend=function(e,t){var n,r;return Array.isArray(e)?(n="/payments/keysend/multi",r={keysends:e.map(function(e){return i({},e,{custom_records:e.customRecords})})}):(n="/payments/keysend",r=i({},e,{custom_records:e.customRecords})),w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:n,request_body:r,method:"POST"}))},t.sendPayment=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/payments/bolt11",request_body:e,method:"POST"}))},t.sendBoostagram=function(e,t){var n,r;return Array.isArray(e)?(n="/payments/keysend/multi",r={keysends:e.map(function(e){return I(e)})}):(n="/payments/keysend",r=I(e)),w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:n,request_body:r,method:"POST"}))},t.sendBoostagramToAlbyAccount=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/payments/keysend",request_body:{destination:"030a58b8653d32b99200a2334cfe913e51dc7d155aa0116c176657a4f1722677a3",custom_records:{696969:e.account},amount:e.amount,memo:e.memo},method:"POST"}))},t.createWebhookEndpoint=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/webhook_endpoints",request_body:e,method:"POST"}))},t.deleteWebhookEndpoint=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/webhook_endpoints/"+e,method:"DELETE"}))},t.getSwapInfo=function(e){return w(i({auth:this.auth},this.defaultRequestOptions,e,{endpoint:"/swaps/info",method:"GET"}))},t.createSwap=function(e,t){return w(i({auth:this.auth},this.defaultRequestOptions,t,{endpoint:"/swaps",method:"POST",request_body:e}))},e}(),A={__proto__:null,auth:S,types:P,utils:m,Client:O};if(68!==new Uint8Array(new Uint32Array([287454020]).buffer)[0])throw new Error("Non little-endian hardware is not supported");const x=/* @__PURE__ */Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function U(e){if(!(e instanceof Uint8Array))throw new Error("Uint8Array expected");let t="";for(let n=0;n<e.length;n++)t+=x[e[n]];return t}function C(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);const t=e.length;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(t/2);for(let t=0;t<n.length;t++){const r=2*t,o=e.slice(r,r+2),i=Number.parseInt(o,16);if(Number.isNaN(i)||i<0)throw new Error("Invalid byte sequence");n[t]=i}return n}var M=/*#__PURE__*/function(e){function t(t,n){var r;return(r=e.call(this,t)||this).code=void 0,r.code=n,r}return s(t,e),t}(/*#__PURE__*/h(Error)),F=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(M),W=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(M),K=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(M),L=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(K),B=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(K),H=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(M),J=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(M),z=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(M),D=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(M),G=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return s(t,e),t}(M);function V(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}function Y(e,t,n){if(!e.s){if(n instanceof X){if(!n.s)return void(n.o=Y.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(Y.bind(null,e,t),Y.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var X=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{Y(r,1,i(this.v))}catch(e){Y(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?Y(r,1,t?t(o):o):n?Y(r,1,n(o)):Y(r,2,o)}catch(e){Y(r,2,e)}},r},e}();function Q(e){return e instanceof X&&1&e.s}var $=/*#__PURE__*/function(){function e(n){this.relay=void 0,this.relayUrl=void 0,this.secret=void 0,this.lud16=void 0,this.walletPubkey=void 0,this.options=void 0,this._encryptionType=void 0,n&&n.nostrWalletConnectUrl&&(n=i({},e.parseWalletConnectUrl(n.nostrWalletConnectUrl),n)),this.options=i({},n||{}),this.relayUrl=this.options.relayUrl,this.relay=new t.Relay(this.relayUrl),this.options.secret&&(this.secret=this.options.secret.toLowerCase().startsWith("nsec")?t.nip19.decode(this.options.secret).data:this.options.secret),this.lud16=this.options.lud16,this.walletPubkey=this.options.walletPubkey.toLowerCase().startsWith("npub")?t.nip19.decode(this.options.walletPubkey).data:this.options.walletPubkey,void 0===globalThis.WebSocket&&console.error("WebSocket is undefined. Make sure to `import websocket-polyfill` for nodejs environments")}e.parseWalletConnectUrl=function(e){e=e.replace("nostrwalletconnect://","http://").replace("nostr+walletconnect://","http://").replace("nostrwalletconnect:","http://").replace("nostr+walletconnect:","http://");var t=new URL(e),n=t.searchParams.get("relay");if(!n)throw new Error("No relay URL found in connection string");var r={walletPubkey:t.host,relayUrl:n},o=t.searchParams.get("secret");o&&(r.secret=o);var i=t.searchParams.get("lud16");return i&&(r.lud16=i),r};var n=e.prototype;return n.getNostrWalletConnectUrl=function(e){void 0===e&&(e=!0);var t="nostr+walletconnect://"+this.walletPubkey+"?relay="+this.relayUrl+"&pubkey="+this.publicKey;return e&&(t=t+"&secret="+this.secret),t},n.getPublicKey=function(){return Promise.resolve(this.publicKey)},n.signEvent=function(e){if(!this.secret)throw new Error("Missing secret key");return Promise.resolve(t.finalizeEvent(e,C(this.secret)))},n.getEventHash=function(e){return t.getEventHash(e)},n.close=function(){return this.relay.close()},n.encrypt=function(e,n){try{var r,o=this;if(!o.secret)throw new Error("Missing secret");var i=function(){if("nip04"===o.encryptionType)return Promise.resolve(t.nip04.encrypt(o.secret,e,n)).then(function(e){r=e});var i=t.nip44.getConversationKey(C(o.secret),e);r=t.nip44.encrypt(n,i)}();return Promise.resolve(i&&i.then?i.then(function(){return r}):r)}catch(e){return Promise.reject(e)}},n.decrypt=function(e,n){try{var r,o=this;if(!o.secret)throw new Error("Missing secret");var i=function(){if("nip04"===o.encryptionType)return Promise.resolve(t.nip04.decrypt(o.secret,e,n)).then(function(e){r=e});var i=t.nip44.getConversationKey(C(o.secret),e);r=t.nip44.decrypt(n,i)}();return Promise.resolve(i&&i.then?i.then(function(){return r}):r)}catch(e){return Promise.reject(e)}},e.getAuthorizationUrl=function(e,t,n){if(void 0===t&&(t={}),e.indexOf("/#/")>-1)throw new Error("hash router paths not supported");var r=new URL(e);return t.name&&r.searchParams.set("name",t.name),r.searchParams.set("pubkey",n),t.returnTo&&r.searchParams.set("return_to",t.returnTo),t.budgetRenewal&&r.searchParams.set("budget_renewal",t.budgetRenewal),t.expiresAt&&r.searchParams.set("expires_at",Math.floor(t.expiresAt.getTime()/1e3).toString()),t.maxAmount&&r.searchParams.set("max_amount",t.maxAmount.toString()),t.requestMethods&&r.searchParams.set("request_methods",t.requestMethods.join(" ")),t.notificationTypes&&r.searchParams.set("notification_types",t.notificationTypes.join(" ")),t.isolated&&r.searchParams.set("isolated","true"),t.metadata&&r.searchParams.set("metadata",JSON.stringify(t.metadata)),r},e.fromAuthorizationUrl=function(n,r,o){void 0===r&&(r={}),o=o||U(t.generateSecretKey()),r.name||(r.name=document.location.host);var i=this.getAuthorizationUrl(n,r,t.getPublicKey(C(o))),s=window.outerHeight/2+window.screenY-300,u=window.outerWidth/2+window.screenX-200;return new Promise(function(t,n){var r=window.open(i.toString(),document.title+" - Wallet Connect","height=600,width=400,top="+s+",left="+u);if(r){var c=function s(u){var c=u.data;c&&"nwc:success"===c.type&&u.origin===i.protocol+"//"+i.host&&(c.relayUrl||n(new Error("no relayUrl in response")),c.walletPubkey||n(new Error("no walletPubkey in response")),t(new e({relayUrl:c.relayUrl,walletPubkey:c.walletPubkey,secret:o,lud16:c.lud16})),clearInterval(a),window.removeEventListener("message",s),r&&r.close())},a=setInterval(function(){r&&r.closed&&(clearInterval(a),window.removeEventListener("message",c),n(new Error("Popup closed")))},500);window.addEventListener("message",c)}else n(new Error("failed to execute window.open"))})},n.getWalletServiceInfo=function(){try{var e=this;return Promise.resolve(e._checkConnected()).then(function(){return Promise.resolve(new Promise(function(t,n){var r=[],o=e.relay.subscribe([{kinds:[13194],limit:1,authors:[e.walletPubkey]}],{eoseTimeout:1e4});o.onevent=function(e){r.push(e)},o.oneose=function(){o.close(),t(r)}})).then(function(e){var t;if(!e.length)throw new Error("no info event (kind 13194) returned from relay");var n=e[0].content,r=e[0].tags.find(function(e){return"notifications"===e[0]}),o=e[0].tags.find(function(e){return"v"===e[0]}),i=e[0].tags.find(function(e){return"encryption"===e[0]}),s=["nip04"];return o&&o[1].includes("1.0")&&s.push("nip44_v2"),i&&(s=i[1].split(" ")),{encryptions:s,capabilities:n.split(/[ |,]/g),notifications:(null==r||null==(t=r[1])?void 0:t.split(" "))||[]}})})}catch(e){return Promise.reject(e)}},n.getInfo=function(){try{var e=this;return Promise.resolve(V(function(){return Promise.resolve(e.executeNip47Request("get_info",{},function(e){return!!e.methods},{replyTimeout:1e4}))},function(e){throw console.error("Failed to request get_info",e),e}))}catch(e){return Promise.reject(e)}},n.getBudget=function(){try{var e=this;return Promise.resolve(V(function(){return Promise.resolve(e.executeNip47Request("get_budget",{},function(e){return void 0!==e},{replyTimeout:1e4}))},function(e){throw console.error("Failed to request get_budget",e),e}))}catch(e){return Promise.reject(e)}},n.getBalance=function(){try{var e=this;return Promise.resolve(V(function(){return Promise.resolve(e.executeNip47Request("get_balance",{},function(e){return void 0!==e.balance},{replyTimeout:1e4}))},function(e){throw console.error("Failed to request get_balance",e),e}))}catch(e){return Promise.reject(e)}},n.payInvoice=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeNip47Request("pay_invoice",e,function(e){return!!e}))},function(e){throw console.error("Failed to request pay_invoice",e),e}))}catch(e){return Promise.reject(e)}},n.payKeysend=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeNip47Request("pay_keysend",e,function(e){return!!e.preimage}))},function(e){throw console.error("Failed to request pay_keysend",e),e}))}catch(e){return Promise.reject(e)}},n.signMessage=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeNip47Request("sign_message",e,function(t){return t.message===e.message&&!!t.signature}))},function(e){throw console.error("Failed to request sign_message",e),e}))}catch(e){return Promise.reject(e)}},n.createConnection=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeNip47Request("create_connection",e,function(e){return!!e.wallet_pubkey}))},function(e){throw console.error("Failed to request create_connection",e),e}))}catch(e){return Promise.reject(e)}},n.multiPayInvoice=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeMultiNip47Request("multi_pay_invoice",e,e.invoices.length,function(e){return!!e.preimage})).then(function(e){return{invoices:e,errors:[]}})},function(e){throw console.error("Failed to request multi_pay_invoice",e),e}))}catch(e){return Promise.reject(e)}},n.multiPayKeysend=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeMultiNip47Request("multi_pay_keysend",e,e.keysends.length,function(e){return!!e.preimage})).then(function(e){return{keysends:e,errors:[]}})},function(e){throw console.error("Failed to request multi_pay_keysend",e),e}))}catch(e){return Promise.reject(e)}},n.makeInvoice=function(e){try{var t=this;return Promise.resolve(V(function(){if(!e.amount)throw new Error("No amount specified");return Promise.resolve(t.executeNip47Request("make_invoice",e,function(e){return!!e.invoice}))},function(e){throw console.error("Failed to request make_invoice",e),e}))}catch(e){return Promise.reject(e)}},n.makeHoldInvoice=function(e){try{var t=this;return Promise.resolve(V(function(){if(!e.amount)throw new Error("No amount specified");if(!e.payment_hash)throw new Error("No payment hash specified");return Promise.resolve(t.executeNip47Request("make_hold_invoice",e,function(e){return!!e.invoice}))},function(e){throw console.error("Failed to request make_hold_invoice",e),e}))}catch(e){return Promise.reject(e)}},n.settleHoldInvoice=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeNip47Request("settle_hold_invoice",e,function(e){return!!e}))},function(e){throw console.error("Failed to request settle_hold_invoice",e),e}))}catch(e){return Promise.reject(e)}},n.cancelHoldInvoice=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeNip47Request("cancel_hold_invoice",e,function(e){return!!e}))},function(e){throw console.error("Failed to request cancel_hold_invoice",e),e}))}catch(e){return Promise.reject(e)}},n.lookupInvoice=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeNip47Request("lookup_invoice",e,function(e){return!!e.invoice}))},function(e){throw console.error("Failed to request lookup_invoice",e),e}))}catch(e){return Promise.reject(e)}},n.listTransactions=function(e){try{var t=this;return Promise.resolve(V(function(){return Promise.resolve(t.executeNip47Request("list_transactions",e,function(e){return!!e.transactions},{replyTimeout:1e4}))},function(e){throw console.error("Failed to request list_transactions",e),e}))}catch(e){return Promise.reject(e)}},n.subscribeNotifications=function(e,t){try{var n,r,o,i=this,s=!0;return function(){try{var u=function(e,t,n){for(var r;;){var o=e();if(Q(o)&&(o=o.v),!o)return i;if(o.then){r=0;break}var i=n();if(i&&i.then){if(!Q(i)){r=1;break}i=i.s}}var s=new X,u=Y.bind(null,s,2);return(0===r?o.then(a):1===r?i.then(c):(void 0).then(function(){(o=e())?o.then?o.then(a).then(void 0,u):a(o):Y(s,1,i)})).then(void 0,u),s;function c(t){i=t;do{if(!(o=e())||Q(o)&&!o.v)return void Y(s,1,i);if(o.then)return void o.then(a).then(void 0,u);Q(i=n())&&(i=i.v)}while(!i||!i.then);i.then(c).then(void 0,u)}function a(e){e?(i=n())&&i.then?i.then(c).then(void 0,u):c(i):Y(s,1,i)}}(function(){return!!s},0,function(){function u(){var e=function(){if(s)return Promise.resolve(new Promise(function(e){return setTimeout(e,1e3)})).then(function(){})}();if(e&&e.then)return e.then(function(){})}var c=V(function(){return Promise.resolve(i._checkConnected()).then(function(){return Promise.resolve(i._selectEncryptionType()).then(function(){return o=i.relay.subscribe([{kinds:[].concat("nip04"===i.encryptionType?[23196]:[23197]),authors:[i.walletPubkey],"#p":[i.publicKey]}],{}),console.info("subscribed to relay"),o.onevent=function(n){try{return Promise.resolve(i.decrypt(i.walletPubkey,n.content)).then(function(n){var r;try{r=JSON.parse(n)}catch(e){return void console.error("Failed to parse decrypted event content",e)}r.notification?(!t||t.indexOf(r.notification_type)>-1)&&e(r):console.error("No notification in response",r)})}catch(e){return Promise.reject(e)}},Promise.resolve(new Promise(function(e){n=function(){e()},i.relay.onclose=r=function(){console.info("relay disconnected"),null==n||n()}})).then(function(){void 0!==r&&(i.relay.onclose=null)})})})},function(e){console.error("error subscribing to notifications",e||"unknown relay error")});return c&&c.then?c.then(u):u()});u&&u.then&&u.then(function(){})}catch(e){Promise.reject(e)}}(),Promise.resolve(function(){var e;s=!1,null==n||n(),null==(e=o)||e.close()})}catch(e){return Promise.reject(e)}},n.executeNip47Request=function(e,t,n,r){try{var o=this;return Promise.resolve(o._checkConnected()).then(function(){return Promise.resolve(o._selectEncryptionType()).then(function(){return new Promise(function(i,s){try{return Promise.resolve(o.encrypt(o.walletPubkey,JSON.stringify({method:e,params:t}))).then(function(e){var t={kind:23194,created_at:Math.floor(Date.now()/1e3),tags:[["p",o.walletPubkey],["v","nip44_v2"===o.encryptionType?"1.0":"0.0"],["encryption",o.encryptionType]],content:e};return Promise.resolve(o.signEvent(t)).then(function(e){var t=o.relay.subscribe([{kinds:[23195],authors:[o.walletPubkey],"#e":[e.id]}],{}),u=setTimeout(function(){t.close(),s(new B("reply timeout: event "+e.id,"INTERNAL"))},(null==r?void 0:r.replyTimeout)||6e4);t.onevent=function(e){try{return clearTimeout(u),t.close(),Promise.resolve(o.decrypt(o.walletPubkey,e.content)).then(function(e){var r,o,c;try{r=JSON.parse(e)}catch(e){return clearTimeout(u),t.close(),void s(new J("failed to deserialize response","INTERNAL"))}r.result?n(r.result)?i(r.result):(clearTimeout(u),t.close(),s(new z("response from NWC failed validation: "+JSON.stringify(r.result),"INTERNAL"))):(clearTimeout(u),t.close(),s(new W((null==(o=r.error)?void 0:o.message)||"unknown Error",(null==(c=r.error)?void 0:c.code)||"INTERNAL")))})}catch(e){return Promise.reject(e)}};var c=setTimeout(function(){t.close(),s(new L("publish timeout: "+e.id,"INTERNAL"))},(null==r?void 0:r.publishTimeout)||5e3),a=V(function(){return Promise.resolve(o.relay.publish(e)).then(function(){clearTimeout(c)})},function(e){clearTimeout(c),s(new H("failed to publish: "+e,"INTERNAL"))});if(a&&a.then)return a.then(function(){})})})}catch(e){Promise.reject(e)}})})})}catch(e){return Promise.reject(e)}},n.executeMultiNip47Request=function(e,t,n,r,o){try{var s=this;return Promise.resolve(s._checkConnected()).then(function(){return Promise.resolve(s._selectEncryptionType()).then(function(){var u=[];return new Promise(function(c,a){try{return Promise.resolve(s.encrypt(s.walletPubkey,JSON.stringify({method:e,params:t}))).then(function(e){var t={kind:23194,created_at:Math.floor(Date.now()/1e3),tags:[["p",s.walletPubkey],["v","nip44_v2"===s.encryptionType?"1.0":"0.0"],["encryption",s.encryptionType]],content:e};return Promise.resolve(s.signEvent(t)).then(function(e){var t=s.relay.subscribe([{kinds:[23195],authors:[s.walletPubkey],"#e":[e.id]}],{}),l=setTimeout(function(){t.close(),a(new B("reply timeout: event "+e.id,"INTERNAL"))},(null==o?void 0:o.replyTimeout)||6e4);t.onevent=function(e){try{return Promise.resolve(s.decrypt(s.walletPubkey,e.content)).then(function(o){var s;try{s=JSON.parse(o)}catch(e){clearTimeout(l),t.close(),a(new J("failed to deserialize response","INTERNAL"))}if(s.result){var h;if(!r(s.result))return clearTimeout(l),t.close(),void a(new z("Response from NWC failed validation: "+JSON.stringify(s.result),"INTERNAL"));var f=null==(h=e.tags.find(function(e){return"d"===e[0]}))?void 0:h[1];if(void 0===f)return clearTimeout(l),t.close(),void a(new z("No d tag found in response event","INTERNAL"));u.push(i({},s.result,{dTag:f})),u.length===n&&(clearTimeout(l),t.close(),c(u))}else{var d,v;clearTimeout(l),t.close(),a(new D(null==(d=s.error)?void 0:d.message,null==(v=s.error)?void 0:v.code))}})}catch(e){return Promise.reject(e)}};var h=setTimeout(function(){t.close(),a(new L("Publish timeout: "+e.id,"INTERNAL"))},(null==o?void 0:o.publishTimeout)||5e3),f=V(function(){return Promise.resolve(s.relay.publish(e)).then(function(){clearTimeout(h)})},function(e){clearTimeout(h),a(new H("Failed to publish: "+e,"INTERNAL"))});if(f&&f.then)return f.then(function(){})})})}catch(e){Promise.reject(e)}})})})}catch(e){return Promise.reject(e)}},n._checkConnected=function(){try{var e=this;if(!e.secret)throw new Error("Missing secret key");if(!e.relayUrl)throw new Error("Missing relay url");return Promise.resolve(V(function(){var t=function(){if(!e.relay.connected)return Promise.resolve(e.relay.connect()).then(function(){})}();if(t&&t.then)return t.then(function(){})},function(){throw console.error("failed to connect to relay",e.relayUrl),new F("Failed to connect to "+e.relayUrl,"OTHER")}))}catch(e){return Promise.reject(e)}},n._selectEncryptionType=function(){try{var e=this;return Promise.resolve(function(){if(!e._encryptionType)return Promise.resolve(e.getWalletServiceInfo()).then(function(t){var n=e._findPreferredEncryptionType(t.encryptions);if(!n)throw new G("no compatible encryption or version found between wallet and client","UNSUPPORTED_ENCRYPTION");"nip04"===n&&console.warn("NIP-04 encryption is about to be deprecated. Please upgrade your wallet service to use NIP-44 instead."),e._encryptionType=n})}())}catch(e){return Promise.reject(e)}},n._findPreferredEncryptionType=function(e){return e.includes("nip44_v2")?"nip44_v2":e.includes("nip04")?"nip04":null},o(e,[{key:"nostrWalletConnectUrl",get:function(){return this.getNostrWalletConnectUrl()}},{key:"connected",get:function(){return this.relay.connected}},{key:"publicKey",get:function(){if(!this.secret)throw new Error("Missing secret key");return t.getPublicKey(C(this.secret))}},{key:"encryptionType",get:function(){if(!this._encryptionType)throw new Error("Missing encryption or version");return this._encryptionType}}]),e}(),Z={get_info:"getInfo",get_balance:"getBalance",make_invoice:"makeInvoice",pay_invoice:"sendPayment",pay_keysend:"payKeysend",lookup_invoice:"lookupInvoice",list_transactions:"listTransactions",multi_pay_invoice:"sendMultiPayment",multi_pay_keysend:"multiKeysend",sign_message:"signMessage"},ee=/*#__PURE__*/function(){function e(e){this._enabled=!1,this.client=void 0,this.subscribers=void 0,this.client=(null==e?void 0:e.client)||new $(e),this.subscribers={}}e.fromAuthorizationUrl=function(t,n,r){void 0===n&&(n={});try{return Promise.resolve($.fromAuthorizationUrl(t,n,r)).then(function(t){return new e({client:t})})}catch(e){return Promise.reject(e)}};var t=e.prototype;return t.on=function(e,t){this.subscribers[e]=t},t.notify=function(e,t){var n=this.subscribers[e];n&&n(t)},t.getPublicKey=function(){return this.client.getPublicKey()},t.signEvent=function(e){return this.client.signEvent(e)},t.enable=function(){try{return this._enabled=!0,Promise.resolve()}catch(e){return Promise.reject(e)}},t.close=function(){return this.client.close()},t.getInfo=function(){try{var e=this;return Promise.resolve(e.checkEnabled()).then(function(){var t=["lightning","nostr"],n="Alby JS SDK";return function(r,o){try{var i=Promise.resolve(e.client.getInfo()).then(function(r){var o={methods:r.methods.map(function(e){return Z[e]}),node:{alias:r.alias,pubkey:r.pubkey,color:r.color},supports:t,version:n};return e.notify("getInfo",o),o})}catch(e){return o(e)}return i&&i.then?i.then(void 0,o):i}(0,function(e){return console.error("Using minimal getInfo",e),{methods:["sendPayment"],node:{},supports:t,version:n}})})}catch(e){return Promise.reject(e)}},t.getBalance=function(){try{var e=this;return Promise.resolve(e.checkEnabled()).then(function(){return Promise.resolve(e.client.getBalance()).then(function(t){var n={balance:Math.floor(t.balance/1e3),currency:"sats"};return e.notify("getBalance",n),n})})}catch(e){return Promise.reject(e)}},t.sendPayment=function(e){try{var t=this;return Promise.resolve(t.checkEnabled()).then(function(){return Promise.resolve(t.client.payInvoice({invoice:e})).then(function(e){var n={preimage:e.preimage};return t.notify("sendPayment",n),n})})}catch(e){return Promise.reject(e)}},t.sendPaymentAsync=function(e){try{var t=this;return Promise.resolve(t.checkEnabled()).then(function(){return t.client.payInvoice({invoice:e}),t.notify("sendPaymentAsync",{}),{}})}catch(e){return Promise.reject(e)}},t.keysend=function(e){try{var t=this;return Promise.resolve(t.checkEnabled()).then(function(){return Promise.resolve(t.client.payKeysend(ne(e))).then(function(e){var n={preimage:e.preimage};return t.notify("keysend",n),n})})}catch(e){return Promise.reject(e)}},t.signMessage=function(e){try{var t=this;return Promise.resolve(t.checkEnabled()).then(function(){return Promise.resolve(t.client.signMessage({message:e})).then(function(e){var n={message:e.message,signature:e.signature};return t.notify("keysend",n),n})})}catch(e){return Promise.reject(e)}},t.makeInvoice=function(e){try{var t=this;return Promise.resolve(t.checkEnabled()).then(function(){var n,r="object"==typeof e?e:void 0,o=+(null!=(n=null==r?void 0:r.amount)?n:e);if(!o)throw new Error("No amount specified");return Promise.resolve(t.client.makeInvoice({amount:1e3*o,description:null==r?void 0:r.defaultMemo})).then(function(e){var n={paymentRequest:e.invoice};return t.notify("makeInvoice",n),n})})}catch(e){return Promise.reject(e)}},t.lookupInvoice=function(e){try{var t=this;return Promise.resolve(t.checkEnabled()).then(function(){return Promise.resolve(t.client.lookupInvoice({invoice:e.paymentRequest,payment_hash:e.paymentHash})).then(function(e){var n={preimage:e.preimage,paymentRequest:e.invoice,paid:!!e.settled_at};return t.notify("lookupInvoice",n),n})})}catch(e){return Promise.reject(e)}},t.listTransactions=function(e){try{var t=this;return Promise.resolve(t.checkEnabled()).then(function(){return Promise.resolve(t.client.listTransactions(e)).then(function(e){var n={transactions:e.transactions.map(te)};return t.notify("listTransactions",n),n})})}catch(e){return Promise.reject(e)}},t.sendMultiPayment=function(e){try{var t=this;return Promise.resolve(t.checkEnabled()).then(function(){return Promise.resolve(t.client.multiPayInvoice({invoices:e.map(function(e,t){return{invoice:e,id:t.toString()}})})).then(function(n){var r={payments:n.invoices.map(function(t){var n=e[parseInt(t.dTag)];if(!n)throw new Error("Could not find paymentRequest matching response d tag");return{paymentRequest:n,preimage:t.preimage}}),errors:[]};return t.notify("sendMultiPayment",r),r})})}catch(e){return Promise.reject(e)}},t.multiKeysend=function(e){try{var t=this;return Promise.resolve(t.checkEnabled()).then(function(){return Promise.resolve(t.client.multiPayKeysend({keysends:e.map(function(e,t){return i({},ne(e),{id:t.toString()})})})).then(function(n){var r={keysends:n.keysends.map(function(t){var n=e[parseInt(t.dTag)];if(!n)throw new Error("Could not find keysend matching response d tag");return{keysend:n,preimage:t.preimage}}),errors:[]};return t.notify("multiKeysend",r),r})})}catch(e){return Promise.reject(e)}},t.lnurl=function(e){throw new Error("Method not implemented.")},t.request=function(e,t){throw new Error("Method not implemented.")},t.verifyMessage=function(e,t){throw new Error("Method not implemented.")},t.checkEnabled=function(){try{if(!this._enabled)throw new Error("please call enable() and await the promise before calling this function");return Promise.resolve()}catch(e){return Promise.reject(e)}},o(e,[{key:"options",get:function(){return this.client.options}}]),e}();function te(e){return i({},e,{amount:Math.floor(e.amount/1e3),fees_paid:e.fees_paid?Math.floor(e.fees_paid/1e3):0})}function ne(e){return{amount:1e3*+e.amount,pubkey:e.destination,tlv_records:e.customRecords?Object.entries(e.customRecords).map(function(e){return{type:parseInt(e[0]),value:E((new TextEncoder).encode(e[1]))}}):[]}}function re(e,t){try{var n=e()}catch(e){return t(!0,e)}return n&&n.then?n.then(t.bind(null,!1),t.bind(null,!0)):t(!1,n)}function oe(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var ie={__proto__:null,NostrWebLNProvider:ee,NWC:ee,OauthWeblnProvider:/*#__PURE__*/function(){function e(e){this.client=void 0,this.auth=void 0,this.oauth=void 0,this.subscribers=void 0,this.isExecuting=void 0,this.auth=e.auth,this.client=new O(e.auth),this.oauth=!0,this.subscribers={},this.isExecuting=!1}var t=e.prototype;return t.on=function(e,t){this.subscribers[e]=t},t.notify=function(e,t){var n=this.subscribers[e];n&&n(t)},t.enable=function(){try{var e,t=this;return t.isExecuting?Promise.resolve():null!=(e=t.auth.token)&&e.access_token?Promise.resolve({enabled:!0}):Promise.resolve(function(){if("undefined"==typeof window||void 0===window.document)throw new Error("Missing access token");var e=re(function(){return t.isExecuting=!0,Promise.resolve(t.openAuthorization()).then(function(){})},function(e,n){if(t.isExecuting=!1,e)throw n;return n});if(e&&e.then)return e.then(function(){})}())}catch(e){return Promise.reject(e)}},t.sendPayment=function(e){try{var t=this;return t.isExecuting?Promise.resolve():Promise.resolve(re(function(){return oe(function(){return t.isExecuting=!0,Promise.resolve(t.client.sendPayment({invoice:e})).then(function(e){return t.notify("sendPayment",e),{preimage:e.payment_preimage}})},function(e){var t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)})},function(e,n){if(t.isExecuting=!1,e)throw n;return n}))}catch(e){return Promise.reject(e)}},t.keysend=function(e){try{var t=this;return t.isExecuting?Promise.resolve():Promise.resolve(re(function(){return oe(function(){return t.isExecuting=!0,Promise.resolve(t.client.keysend(e)).then(function(e){return t.notify("keysend",e),{preimage:e.payment_preimage}})},function(e){var t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)})},function(e,n){if(t.isExecuting=!1,e)throw n;return n}))}catch(e){return Promise.reject(e)}},t.getInfo=function(){try{return Promise.resolve({alias:"Alby"})}catch(e){return Promise.reject(e)}},t.makeInvoice=function(e){try{var t=this;return t.isExecuting?Promise.resolve():Promise.resolve(re(function(){return oe(function(){return t.isExecuting=!0,Promise.resolve(t.client.createInvoice({amount:parseInt(e.amount.toString()),description:e.defaultMemo})).then(function(e){return t.notify("makeInvoice",e),{paymentRequest:e.payment_request}})},function(e){var t="Unknown Error";throw e instanceof Error&&(t=e.message),new Error(t)})},function(e,n){if(t.isExecuting=!1,e)throw n;return n}))}catch(e){return Promise.reject(e)}},t.openAuthorization=function(){try{var e=this,t=window.outerHeight/2+window.screenY-350,n=window.outerWidth/2+window.screenX-300;return Promise.resolve(e.auth.generateAuthURL({code_challenge_method:"S256"})).then(function(r){return new Promise(function(o,i){var s=window.open(r,document.title+" - WebLN enable","height=700,width=600,top="+t+",left="+n),u=!1;window.addEventListener("message",function(t){try{var n=t.data,r=function(){if(n&&"alby:oauth:success"===n.type&&t.origin===document.location.protocol+"//"+document.location.host&&!u){u=!0,console.info("Processing OAuth code response");var r=n.payload.code,c=oe(function(){return Promise.resolve(e.auth.requestAccessToken(r)).then(function(){e.client=new O(e.auth),s&&s.close(),e.notify("enable"),o({enabled:!0})})},function(e){console.error(e),i({enabled:!1})});if(c&&c.then)return c.then(function(){})}}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})})})}catch(e){return Promise.reject(e)}},e}()};function se(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}function ue(e,t,n){if(!e.s){if(n instanceof ce){if(!n.s)return void(n.o=ue.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(ue.bind(null,e,t),ue.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var ce=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{ue(r,1,i(this.v))}catch(e){ue(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?ue(r,1,t?t(o):o):n?ue(r,1,n(o)):ue(r,2,o)}catch(e){ue(r,2,e)}},r},e}();function ae(e){return e instanceof ce&&1&e.s}var le=/*#__PURE__*/function(){function e(e){if(this.options=void 0,this.appSecretKey=void 0,this.relay=void 0,this.appSecretKey=e.appSecretKey||U(t.generateSecretKey()),this.options=i({},e,{appPubkey:t.getPublicKey(C(this.appSecretKey))}),!this.options.relayUrl)throw new Error("Missing relay url");if(!this.options.requestMethods)throw new Error("Missing request methods");this.relay=new t.Relay(this.options.relayUrl),void 0===globalThis.WebSocket&&console.error("WebSocket is undefined. Make sure to `import websocket-polyfill` for nodejs environments")}var n=e.prototype;return n.getConnectionUri=function(e){void 0===e&&(e="");var t=new URLSearchParams(i({relay:this.options.relayUrl,request_methods:this.options.requestMethods.join(" ")},this.options.name?{name:this.options.name}:{},this.options.icon?{icon:this.options.icon}:{},this.options.returnTo?{return_to:this.options.returnTo}:{},this.options.notificationTypes?{notification_types:this.options.notificationTypes.join(" ")}:{},this.options.maxAmount?{max_amount:this.options.maxAmount.toString()}:{},this.options.budgetRenewal?{budget_renewal:this.options.budgetRenewal}:{},this.options.expiresAt?{expires_at:this.options.expiresAt.toString()}:{},this.options.isolated?{isolated:this.options.isolated.toString()}:{},this.options.metadata?{metadata:JSON.stringify(this.options.metadata)}:{}));return"nostr+walletauth"+(e?"+"+e:"")+"://"+this.options.appPubkey+"?"+t.toString().replace(/\+/g,"%20")},e.parseWalletAuthUrl=function(e){var t,n;if(!e.startsWith("nostr+walletauth"))throw new Error("Unexpected scheme. Should be nostr+walletauth:// or nostr+walletauth+specificapp://");var r=e.indexOf(":");(e=e.substring(r+1)).startsWith("//")&&(e=e.substring(2)),e="http://"+e;var o=new URL(e),i=o.host;if(64!==(null==i?void 0:i.length))throw new Error("Incorrect app pubkey found in auth string");var s=o.searchParams.get("relay");if(!s)throw new Error("No relay URL found in auth string");var u=null==(t=o.searchParams.get("request_methods"))?void 0:t.split(" ");if(null==u||!u.length)throw new Error("No request methods found in auth string");var c=null==(n=o.searchParams.get("notification_types"))?void 0:n.split(" "),a=o.searchParams.get("max_amount"),l=o.searchParams.get("expires_at"),h=o.searchParams.get("metadata");return{name:o.searchParams.get("name")||void 0,icon:o.searchParams.get("icon")||void 0,returnTo:o.searchParams.get("return_to")||void 0,relayUrl:s,appPubkey:i,requestMethods:u,notificationTypes:c,budgetRenewal:o.searchParams.get("budget_renewal"),expiresAt:l?parseInt(l):void 0,maxAmount:a?parseInt(a):void 0,isolated:"true"===o.searchParams.get("isolated"),metadata:h?JSON.parse(h):void 0}},n.subscribe=function(e){try{var t,n,r=this,o=!0;return function(){try{var i=function(e,t,n){for(var r;;){var o=e();if(ae(o)&&(o=o.v),!o)return i;if(o.then){r=0;break}var i=n();if(i&&i.then){if(!ae(i)){r=1;break}i=i.s}}var s=new ce,u=ue.bind(null,s,2);return(0===r?o.then(a):1===r?i.then(c):(void 0).then(function(){(o=e())?o.then?o.then(a).then(void 0,u):a(o):ue(s,1,i)})).then(void 0,u),s;function c(t){i=t;do{if(!(o=e())||ae(o)&&!o.v)return void ue(s,1,i);if(o.then)return void o.then(a).then(void 0,u);ae(i=n())&&(i=i.v)}while(!i||!i.then);i.then(c).then(void 0,u)}function a(e){e?(i=n())&&i.then?i.then(c).then(void 0,u):c(i):ue(s,1,i)}}(function(){return!!o},0,function(){function i(){var e=function(){if(o)return Promise.resolve(new Promise(function(e){return setTimeout(e,1e3)})).then(function(){})}();if(e&&e.then)return e.then(function(){})}var s=se(function(){return Promise.resolve(r._checkConnected()).then(function(){var o=r.relay.subscribe([{kinds:[13194],"#p":[r.options.appPubkey]}],{});return console.info("subscribed to relay"),o.onevent=function(t){try{var n=function(){e.onSuccess(i),o.close(),r.relay.close()},i=new $({relayUrl:r.options.relayUrl,secret:r.appSecretKey,walletPubkey:t.pubkey}),s=se(function(){return Promise.resolve(i.getInfo()).then(function(e){i.options.lud16=e.lud16,i.lud16=e.lud16})},function(e){console.error("failed to fetch get_info",e)});return Promise.resolve(s&&s.then?s.then(n):n())}catch(e){return Promise.reject(e)}},Promise.resolve(new Promise(function(e){t=function(){e()},r.relay.onclose=n=function(){console.info("relay disconnected"),null==t||t()}})).then(function(){void 0!==n&&(r.relay.onclose=null)})})},function(e){console.error("error subscribing to info event",e||"unknown relay error")});return s&&s.then?s.then(i):i()});i&&i.then&&i.then(function(){})}catch(e){Promise.reject(e)}}(),Promise.resolve({unsub:function(){o=!1,null==t||t()}})}catch(e){return Promise.reject(e)}},n._checkConnected=function(){try{var e=this;if(!e.appSecretKey)throw new Error("Missing secret key");if(!e.options.relayUrl)throw new Error("Missing relay url");return Promise.resolve(se(function(){var t=function(){if(!e.relay.connected)return Promise.resolve(e.relay.connect()).then(function(){})}();if(t&&t.then)return t.then(function(){})},function(){throw console.error("failed to connect to relay",e.options.relayUrl),new F("Failed to connect to "+e.options.relayUrl,"OTHER")}))}catch(e){return Promise.reject(e)}},o(e,[{key:"connectionUri",get:function(){return this.getConnectionUri()}}]),e}();function he(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}function fe(e,t,n){if(!e.s){if(n instanceof de){if(!n.s)return void(n.o=fe.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(fe.bind(null,e,t),fe.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var de=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{fe(r,1,i(this.v))}catch(e){fe(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?fe(r,1,t?t(o):o):n?fe(r,1,n(o)):fe(r,2,o)}catch(e){fe(r,2,e)}},r},e}();function ve(e){return e instanceof de&&1&e.s}var pe=/*#__PURE__*/function(){function e(e){this.relay=void 0,this.relayUrl=void 0,this.relayUrl=e.relayUrl,this.relay=new t.Relay(this.relayUrl),void 0===globalThis.WebSocket&&console.error("WebSocket is undefined. Make sure to `import websocket-polyfill` for nodejs environments")}var n=e.prototype;return n.publishWalletServiceInfoEvent=function(e,t,n){try{var r=this;return Promise.resolve(he(function(){return Promise.resolve(r._checkConnected()).then(function(){var o={kind:13194,created_at:Math.floor(Date.now()/1e3),tags:[["encryption","nip04 nip44_v2"],["notifications",n.join(" ")]],content:t.join(" ")};return Promise.resolve(r.signEvent(o,e)).then(function(e){return Promise.resolve(r.relay.publish(e)).then(function(){})})})},function(e){throw console.error("failed to publish wallet service info event",e),e}))}catch(e){return Promise.reject(e)}},n.subscribe=function(e,t){try{var n,r,o,s=this,u=!0;return function(){try{var c=function(e,t,n){for(var r;;){var o=e();if(ve(o)&&(o=o.v),!o)return i;if(o.then){r=0;break}var i=n();if(i&&i.then){if(!ve(i)){r=1;break}i=i.s}}var s=new de,u=fe.bind(null,s,2);return(0===r?o.then(a):1===r?i.then(c):(void 0).then(function(){(o=e())?o.then?o.then(a).then(void 0,u):a(o):fe(s,1,i)})).then(void 0,u),s;function c(t){i=t;do{if(!(o=e())||ve(o)&&!o.v)return void fe(s,1,i);if(o.then)return void o.then(a).then(void 0,u);ve(i=n())&&(i=i.v)}while(!i||!i.then);i.then(c).then(void 0,u)}function a(e){e?(i=n())&&i.then?i.then(c).then(void 0,u):c(i):fe(s,1,i)}}(function(){return!!u},0,function(){function c(){var e=function(){if(u)return Promise.resolve(new Promise(function(e){return setTimeout(e,1e3)})).then(function(){})}();if(e&&e.then)return e.then(function(){})}var a=he(function(){return console.info("checking connection to relay"),Promise.resolve(s._checkConnected()).then(function(){return console.info("subscribing to relay"),o=s.relay.subscribe([{kinds:[23194],authors:[e.clientPubkey],"#p":[e.walletPubkey]}],{}),console.info("subscribed to relay"),o.onevent=function(n){try{var r=he(function(){var r,o=(null==(r=n.tags.find(function(e){return"encryption"===e[0]}))?void 0:r[1])||"nip04";return Promise.resolve(s.decrypt(e,n.content,o)).then(function(r){var u,c=JSON.parse(r);switch(c.method){case"get_info":u=null==t.getInfo?void 0:t.getInfo();break;case"make_invoice":u=null==t.makeInvoice?void 0:t.makeInvoice(c.params);break;case"pay_invoice":u=null==t.payInvoice?void 0:t.payInvoice(c.params);break;case"pay_keysend":u=null==t.payKeysend?void 0:t.payKeysend(c.params);break;case"get_balance":u=null==t.getBalance?void 0:t.getBalance();break;case"lookup_invoice":u=null==t.lookupInvoice?void 0:t.lookupInvoice(c.params);break;case"list_transactions":u=null==t.listTransactions?void 0:t.listTransactions(c.params);break;case"sign_message":u=null==t.signMessage?void 0:t.signMessage(c.params)}return Promise.resolve(u).then(function(t){t||(console.warn("received unsupported method",c.method),t={error:{code:"NOT_IMPLEMENTED",message:"This method is not supported by the wallet service"},result:void 0});var r=[["e",n.id]],u=Math.floor(Date.now()/1e3);return Promise.resolve(s.encrypt(e,JSON.stringify(i({result_type:c.method},t)),o)).then(function(t){return Promise.resolve(s.signEvent({kind:23195,created_at:u,tags:r,content:t},e.walletSecret)).then(function(e){return Promise.resolve(s.relay.publish(e)).then(function(){})})})})})},function(e){console.error("Failed to parse decrypted event content",e)});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},Promise.resolve(new Promise(function(e){n=function(){e()},s.relay.onclose=r=function(){console.error("relay disconnected"),null==n||n()}})).then(function(){void 0!==r&&(s.relay.onclose=null)})})},function(e){console.error("error subscribing to requests",e||"unknown relay error")});return a&&a.then?a.then(c):c()});c&&c.then&&c.then(function(){})}catch(e){Promise.reject(e)}}(),Promise.resolve(function(){var e;u=!1,null==n||n(),null==(e=o)||e.close()})}catch(e){return Promise.reject(e)}},n.signEvent=function(e,n){return Promise.resolve(t.finalizeEvent(e,C(n)))},n.close=function(){return this.relay.close()},n.encrypt=function(e,n,r){try{var o,i=function(){if("nip04"===r)return Promise.resolve(t.nip04.encrypt(e.walletSecret,e.clientPubkey,n)).then(function(e){o=e});var i=t.nip44.getConversationKey(C(e.walletSecret),e.clientPubkey);o=t.nip44.encrypt(n,i)}();return Promise.resolve(i&&i.then?i.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},n.decrypt=function(e,n,r){try{var o,i=function(){if("nip04"===r)return Promise.resolve(t.nip04.decrypt(e.walletSecret,e.clientPubkey,n)).then(function(e){o=e});var i=t.nip44.getConversationKey(C(e.walletSecret),e.clientPubkey);o=t.nip44.decrypt(n,i)}();return Promise.resolve(i&&i.then?i.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},n._checkConnected=function(){try{var e=this;if(!e.relayUrl)throw new Error("Missing relay url");return Promise.resolve(he(function(){var t=function(){if(!e.relay.connected)return Promise.resolve(e.relay.connect()).then(function(){})}();if(t&&t.then)return t.then(function(){})},function(){throw console.error("failed to connect to relay",e.relayUrl),new F("Failed to connect to "+e.relayUrl,"OTHER")}))}catch(e){return Promise.reject(e)}},o(e,[{key:"connected",get:function(){return this.relay.connected}}]),e}(),me={__proto__:null,Nip47Error:M,Nip47NetworkError:F,Nip47WalletError:W,Nip47TimeoutError:K,Nip47PublishTimeoutError:L,Nip47ReplyTimeoutError:B,Nip47PublishError:H,Nip47ResponseDecodingError:J,Nip47ResponseValidationError:z,Nip47UnexpectedResponseError:D,Nip47UnsupportedEncryptionError:G,NWCClient:$,NWAClient:le,NWCWalletServiceKeyPair:function(e,n){if(this.walletSecret=void 0,this.walletPubkey=void 0,this.clientPubkey=void 0,this.walletSecret=e,this.clientPubkey=n,!this.walletSecret)throw new Error("Missing wallet secret key");if(!this.clientPubkey)throw new Error("Missing client pubkey");this.walletPubkey=t.getPublicKey(C(this.walletSecret))},NWCWalletService:pe};function ye(e,t,n){if(!e.s){if(n instanceof Pe){if(!n.s)return void(n.o=ye.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(ye.bind(null,e,t),ye.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var Pe=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,o=this.s;if(o){var i=1&o?t:n;if(i){try{ye(r,1,i(this.v))}catch(e){ye(r,2,e)}return r}return this}return this.o=function(e){try{var o=e.v;1&e.s?ye(r,1,t?t(o):o):n?ye(r,1,n(o)):ye(r,2,o)}catch(e){ye(r,2,e)}},r},e}();function ge(e){return e instanceof Pe&&1&e.s}var we=/*#__PURE__*/function(){function e(e,t){this.transaction=void 0,this.invoice=void 0,this._nwcClient=void 0,this._unsubscribeFunc=void 0,this._timeoutFunc=void 0,this._timeoutId=void 0,this.transaction=t,this.invoice=new n.Invoice({pr:t.invoice}),this._nwcClient=e}var t=e.prototype;return t.onPaid=function(e){var t=this;return function(){try{var n,r=function(){var r=function(n){null==t._unsubscribeFunc||t._unsubscribeFunc(),e(n)},o=function(e){return function(){t._timeoutFunc=void 0,clearTimeout(t._timeoutId),e()}},i=function(){if(n)return Promise.resolve(t._nwcClient.subscribeNotifications(function(e){e.notification.payment_hash===t.transaction.payment_hash&&r(e.notification)},["payment_received"])).then(function(e){t._unsubscribeFunc=o(e)});console.warn("current connection does not support notifications, falling back to polling"),t._unsubscribeFunc=o(t._onPaidPollingFallback(r))}();if(i&&i.then)return i.then(function(){})},o=function(e,r){try{var o=Promise.resolve(t._nwcClient.getInfo()).then(function(e){var t;n=null==(t=e.notifications)?void 0:t.includes("payment_received")})}catch(e){return r()}return o&&o.then?o.then(void 0,r):o}(0,function(){console.error("failed to fetch info, falling back to polling")});o&&o.then?o.then(r):r()}catch(e){Promise.reject(e)}}(),this},t.onTimeout=function(e,t){var n=this;return this._timeoutFunc=function(){null==n._unsubscribeFunc||n._unsubscribeFunc(),t()},this._timeoutId=setTimeout(function(){null==n._timeoutFunc||n._timeoutFunc()},1e3*e),this},t.unsubscribe=function(){var e;null==(e=this._unsubscribeFunc)||e.call(this)},t._onPaidPollingFallback=function(e){var t=this,n=!0;return function(r){try{var o=function(e,t,n){for(var r;;){var o=e();if(ge(o)&&(o=o.v),!o)return i;if(o.then){r=0;break}var i=n();if(i&&i.then){if(!ge(i)){r=1;break}i=i.s}}var s=new Pe,u=ye.bind(null,s,2);return(0===r?o.then(a):1===r?i.then(c):(void 0).then(function(){(o=e())?o.then?o.then(a).then(void 0,u):a(o):ye(s,1,i)})).then(void 0,u),s;function c(t){i=t;do{if(!(o=e())||ge(o)&&!o.v)return void ye(s,1,i);if(o.then)return void o.then(a).then(void 0,u);ge(i=n())&&(i=i.v)}while(!i||!i.then);i.then(c).then(void 0,u)}function a(e){e?(i=n())&&i.then?i.then(c).then(void 0,u):c(i):ye(s,1,i)}}(function(){return!r&&!!n},0,function(){return Promise.resolve(t._nwcClient.lookupInvoice({payment_hash:t.transaction.payment_hash})).then(function(t){return t.settled_at&&t.preimage?(e(t),n=!1,void(r=1)):Promise.resolve(new Promise(function(e){return setTimeout(e,3e3)})).then(function(){})})});o&&o.then&&o.then(function(){})}catch(e){Promise.reject(e)}}(),function(){n=!1}},e}(),be=function(e){try{return"number"==typeof e?Promise.resolve({satoshi:e,millisat:1e3*e}):Promise.resolve(Promise.resolve(e.satoshi)).then(function(e){return{satoshi:e,millisat:1e3*e}})}catch(e){return Promise.reject(e)}},_e=/*#__PURE__*/function(){function e(e){this.nwcClient=void 0,this.nwcClient="string"==typeof e?new $({nostrWalletConnectUrl:e}):e instanceof $?e:new $(e)}var t=e.prototype;return t.pay=function(e,t,r){try{var o=function(t){function o(e){return Promise.resolve(s.nwcClient.payInvoice(i({},r||{},{invoice:u,amount:null==t?void 0:t.millisat}))).then(function(e){return i({},e,{invoice:new n.Invoice({pr:u})})})}var c=function(){if(u.indexOf("@")>-1){if(!t)throw new Error("Amount must be provided when paying to a lightning address");var o=new n.LightningAddress(e);return Promise.resolve(o.fetch()).then(function(){var e,n;return Promise.resolve(o.requestInvoice({satoshi:t.satoshi,comment:null==r||null==(e=r.metadata)?void 0:e.comment,payerdata:null==r||null==(n=r.metadata)?void 0:n.payer_data})).then(function(e){u=e.paymentRequest})})}}();return c&&c.then?c.then(o):o()},s=this,u=e;return Promise.resolve(t?Promise.resolve(be(t)).then(o):o(void 0))}catch(e){return Promise.reject(e)}},t.requestPayment=function(e,t){try{var n=this;return Promise.resolve(be(e)).then(function(e){return Promise.resolve(n.nwcClient.makeInvoice(i({},t||{},{amount:e.millisat}))).then(function(e){return new we(n.nwcClient,e)})})}catch(e){return Promise.reject(e)}},t.close=function(){this.nwcClient.close()},e}(),ke=function(e,t){this.satoshi=void 0,this.satoshi=n.fiat.getSatoshiValue({amount:e,currency:t})};e.CHF=function(e){return new ke(e,"CHF")},e.EUR=function(e){return new ke(e,"EUR")},e.FiatAmount=ke,e.GBP=function(e){return new ke(e,"GBP")},e.JPY=function(e){return new ke(e,"JPY")},e.LN=_e,e.LNClient=_e,e.ReceiveInvoice=we,e.SATS=function(e){return{satoshi:e}},e.USD=function(e){return new ke(e,"USD")},e.nwc=me,e.oauth=A,e.resolveAmount=be,e.webln=ie});
